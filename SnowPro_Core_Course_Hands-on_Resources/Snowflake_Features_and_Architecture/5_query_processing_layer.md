Query Processing Layer
=======================

The query processing layer consists of `Virtual Warehouses`
that execute the processing tasks required 
to return results for most SQL statements.

* Virtual Warehouses - 
  A virtual warehouse is a `snowflake object you create via SQL commands`.

  It's a `named abstraction for a cluster of cloud-based compute instances that snowflake provision and manage`.
  If we were to execute this create warehouse statement in our trial account, which is deployed into AWS.
  
  Behind the scenes, `the virtual warehouse would be composed of EC2 instances arranged together as a distributed compute cluster`.
  
  - These run the `software of the execution engine` snowflake designed for the cloud.
  - This carries out the `computation task of the query plan` generated by the services layer.

        And because Snowflake is a solution, as users, we have no direct access to those nodes. 
        We interact with just the abstracted warehouse object

  - Under the hood, These compute clusters cooperate in a very similar way to `shared nothing architectures`.
  - Virtual warehouses make a `remote call to the storage layer` when a query is issued to them, 
    and then the `raw table data retrieved is stored on a local cache` made up of high speed storage.
  - This `cached data` can be used to compute results for subsequent queries.

- Virtual Warehouses are `ephemeral` and `highly-flexible`

    What does this mean ?
    1. Virtual warehouses can be created and dropped instantly by the user, just like table or database.
        Behind the scenes, 
        `Snowflake will provision the compute instances when a create statement is issued`
        and 
        `Snowflake will remove the compute instances when it's dropped`.
    2. Once the warehouses are created, they can be paused or resumed. 
        - In a paused state, you are not charged for compute.
        - This gives us the ability to match the compute resource to when we need it, rather than provisioning for peak capacity and potentially not using it after time. 
        - This can be quite useful in situations where you have a variable usage curve with most computation happening at specific windows throughout the day.
   
    Ability to create virtual warehouses has some key advantages:-
    1. Scale-out compute to handle highly concurrent workloads.
    2. Each warehouse is isolated from each other.
   
        This means we could create a virtual warehouse for data loading and another for data analysis, 
        and there would be no resource contention between them.

  - On top of this, each virtual warehouse can `have its own configuration` for each unique workload. 
        A key virtual warehouse configuration comes in multiple `T-Shirt` sizes. 
        - Virtual warehouses come in many sizes which indicate their relative compute power.
        - The size relates to the number of `cloud compute instances`. 
        - They range from `extra small` to `six times extra large`.
        - Snowflake will provision to make up a warehouse and the capability of the hardware of those compute instances.

  - All running warehouses have `consistent access to the same data in the storage layer`.

   
* You can imagine the complexity involved in synchronizing all the reads and writes from potentially hundreds of virtual warehouses to a single storage location.
    How does Snowflake handle this?
      - Snowflake is not an `eventually consistent system`.
      - It uses strict `ACID compliant` processing to ensure that `all updates and inserts are immediately available to all virtual warehouses`.
      - This is primarily achieved by a service in the global services layer called the 
      `Transaction Manager` -  which synchronizes data access.